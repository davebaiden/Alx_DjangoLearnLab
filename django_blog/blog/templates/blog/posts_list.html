{% extends "blog/base.html" %}
{% block content %}
<div class="container mt-4">

  <!-- 🔍 Search Bar -->
  <form action="{% url 'search-results' %}" method="get" class="d-flex mb-4">
    <input type="text" name="q" class="form-control me-2"
           placeholder="Search posts or tags..."
           value="{{ request.GET.q|default:'' }}">
    <button type="submit" class="btn btn-primary">Search</button>
  </form>

  <!-- 🏷️ Tag Filter Indicator -->
  {% if tag_name %}
    <h2 class="mb-4">Posts tagged with: <span class="text-info">#{{ tag_name }}</span></h2>
  {% endif %}

  <!-- 📜 Posts List -->
  {% if posts %}
    {% for post in posts %}
      <article class="mb-5 p-4 border rounded shadow-sm">
        <h2>
          <a href="{% url 'post-detail' post.pk %}" class="text-decoration-none text-dark">
            {{ post.title }}
          </a>
        </h2>
        <p class="text-muted mb-1">
          By <strong>{{ post.author.username }}</strong> — {{ post.published_date|date:"M d, Y" }}
        </p>

        <p class="mt-2">{{ post.content|truncatechars:200 }}</p>

        <!-- 🏷️ Tags Display -->
        <p class="mt-3">
          <strong>Tags:</strong>
          {% if post.tags.all %}
            {% for tag in post.tags.all %}
              <a href="{% url 'posts-by-tag' tag_name=tag.slug %}" class="badge bg-secondary text-decoration-none">
                {{ tag.name }}
              </a>
            {% endfor %}
          {% else %}
            <span class="text-muted">No tags</span>
          {% endif %}
        </p>

        <a href="{% url 'post-detail' post.pk %}" class="btn btn-outline-primary btn-sm mt-2">
          Read More
        </a>
      </article>
    {% endfor %}

    <!-- 📄 Pagination -->
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center">
        {% if posts.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ posts.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
              Previous
            </a>
          </li>
        {% endif %}

        {% for num in posts.paginator.page_range %}
          {% if posts.number == num %}
            <li class="page-item active">
              <span class="page-link">{{ num }}</span>
            </li>
          {% elif num > posts.number|add:'-3' and num < posts.number|add:'3' %}
            <li class="page-item">
              <a class="page-link" href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
                {{ num }}
              </a>
            </li>
          {% endif %}
        {% endfor %}

        {% if posts.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ posts.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}">
              Next
            </a>
          </li>
        {% endif %}
      </ul>
    </nav>

  {% else %}
    <div class="text-center mt-5">
      <p class="text-muted fs-5">No posts found.</p>
    </div>
  {% endif %}
</div>
{% endblock %}
